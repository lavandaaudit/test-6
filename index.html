<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>PLANET CHAOS · COSMOS · SUN · GRAPH</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  color:#0af;
  font-family:'Courier New', monospace;
  overflow:hidden;
}
#hud{
  position:absolute;
  top:14px;
  left:16px;
  font-size:14px;
  opacity:.85;
}
#status{
  position:absolute;
  top:36px;
  left:16px;
  font-size:11px;
  color:#0f0;
  opacity:.6;
}
#clock{
  position:absolute;
  bottom:12px;
  right:16px;
  font-size:11px;
  opacity:.4;
}
canvas{
  position:absolute;
  inset:0;
}
</style>
</head>

<body>
<div id="hud">Lavanda.audit.ibonarium.project · COSMOS / SUN</div>
<div id="status">ініціалізація…</div>
<div id="clock"></div>
<canvas id="graph"></canvas>

<script>
const canvas = document.getElementById('graph');
const ctx = canvas.getContext('2d');
const statusDiv = document.getElementById('status');
const clockDiv = document.getElementById('clock');
const proxy = 'https://corsproxy.io/?';

let W,H;
function resize(){
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
}
window.addEventListener('resize',resize);
resize();

/* ───── CLOCK ───── */
const startTime = Date.now();
setInterval(()=>{
  const d = new Date();
  const up = Math.floor((Date.now()-startTime)/1000);
  clockDiv.innerHTML = `${d.toLocaleTimeString()}<br>uptime ${up}s`;
},1000);

/* ───── DATA BUFFER ───── */
const MAX_POINTS = 60; // 60 хвилин
let series = []; // {t, v}

/* ───── FETCH ───── */
async function fetchJSON(url){
  try{
    const r = await fetch(proxy+encodeURIComponent(url));
    return r.ok ? r.json() : null;
  }catch{ return null; }
}

async function loadData(){
  statusDiv.textContent = 'оновлення сонячного сигналу…';

  const plasma = await fetchJSON(
    'https://services.swpc.noaa.gov/products/solar-wind/plasma-7-day.json'
  );

  if(plasma && plasma.length>1){
    const p = plasma.at(-1);
    const speed = +p[3];
    if(!isNaN(speed)){
      series.push({ t: Date.now(), v: speed });
      if(series.length > MAX_POINTS) series.shift();
      statusDiv.textContent = `Solar Wind Speed ${speed.toFixed(0)} km/s`;
    }
  }
}

/* ───── GRAPH ───── */
function drawGrid(){
  ctx.strokeStyle = 'rgba(0,170,255,0.15)';
  ctx.lineWidth = 1;

  for(let i=0;i<10;i++){
    const x = i/10*W;
    const y = i/10*H;
    ctx.beginPath();
    ctx.moveTo(x,0); ctx.lineTo(x,H);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0,y); ctx.lineTo(W,y);
    ctx.stroke();
  }
}

function drawAxes(){
  ctx.strokeStyle='#0af';
  ctx.lineWidth=1.5;
  ctx.beginPath();
  ctx.moveTo(60,20);
  ctx.lineTo(60,H-40);
  ctx.lineTo(W-20,H-40);
  ctx.stroke();
}

function drawSeries(){
  if(series.length<2) return;

  const values = series.map(p=>p.v);
  const min = Math.min(...values)*0.95;
  const max = Math.max(...values)*1.05;

  const plotW = W-100;
  const plotH = H-80;

  ctx.lineWidth=2;
  ctx.strokeStyle='#0f0';
  ctx.beginPath();

  series.forEach((p,i)=>{
    const x = 60 + i/(MAX_POINTS-1)*plotW;
    const y = 20 + (1-(p.v-min)/(max-min))*plotH;
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // точки
  ctx.fillStyle='#0f0';
  series.forEach((p,i)=>{
    const x = 60 + i/(MAX_POINTS-1)*plotW;
    const y = 20 + (1-(p.v-min)/(max-min))*plotH;
    ctx.beginPath();
    ctx.arc(x,y,3,0,Math.PI*2);
    ctx.fill();
  });

  // підписи
  ctx.fillStyle='#6cf';
  ctx.font='10px Courier New';
  ctx.fillText(`max ${max.toFixed(0)} km/s`,10,18);
  ctx.fillText(`min ${min.toFixed(0)} km/s`,10,H-44);
}

/* ───── LOOP ───── */
function render(){
  ctx.clearRect(0,0,W,H);
  drawGrid();
  drawAxes();
  drawSeries();
  requestAnimationFrame(render);
}

loadData();
setInterval(loadData,60000);
render();
</script>
</body>
</html>
